# @format

name: Nodejs Ubuntu CI/CD
# triggers
on:
  push:
  pull_request:
  workflow_dispatch:

# workflow
jobs:
  # build gatsby
  build:
    # simple description
    name: Build
    # runner os
    runs-on: ubuntu-latest
    # cache build artifacts
    steps:
      - name: Caching Gatsby
        id: gatsby-cache-build
        uses: actions/cache@v2
        with:
          path: |
            public
            .cache
          key: ${{ runner.os }}-gatsby-build-${{ github.run_id }}
          restore-keys: ${{ runner.os }}-gatsby-build-
      # check out repo
      - name: Checkout
        uses: actions/checkout@v2
      # install node_modules
      - name: Install
        run: yarn install
      # build gatsby
      - name: Build
        run: yarn build
        env:
          GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES: true
          NODE_ENV: production
      # archive production artifact for build step
      - name: Archive
        uses: actions/upload-artifact@v2
        with:
          name: public
          path: public

  # deploy gatsby
  deploy:
    # simple description
    name: Deploy
    # requires build step to start
    needs: build
    # runner os
    runs-on: ubuntu-latest
    steps:
      # checkout repo
      - name: Checkout
        uses: actions/checkout@v2
      # download build artifact
      - name: Download
        uses: actions/download-artifact@v2
        with:
          name: public
          path: public
      # This command deploys your Hosting content and config
      # to the following Firebase-provisioned subdomains:
      #
      # PROJECT_ID.web.app
      # PROJECT_ID.firebaseapp.com
      #
      # $ firebase deploy --only hosting
      #
      - name: Deploy
        uses: w9jds/firebase-action@v2.0.0
        with:
          args: deploy
        # firebase token for deploy
        env:
          FIREBASE_TOKEN: ${{secrets.FIREBASE_TOKEN}}
